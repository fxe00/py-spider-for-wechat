## 公众号爬取订阅平台方案（推荐）

### 目标

- 将现有爬虫核心封装为服务能力，提供可配置的定时爬取、结果展示和账号管理。
- 前端使用 Vue3 + Vite + Element Plus，支持登录鉴权。
- 后端使用 Flask（Python）+ MongoDB，提供 REST API 与调度任务。
- 单 Docker 部署，多阶段构建，便于一键运行。

### 整体架构

- frontend：Vue3 + Vite + Element Plus，路由守卫 + JWT，axios 拦截器。
- backend：Flask，使用 pymongo 访问 Mongo；APScheduler 负责周期任务；JWT 鉴权。
- crawler：复用现有爬虫逻辑，剥离 PyQt 依赖，封装为纯函数。
- db：MongoDB（容器外部或 docker-compose 内部）。
- 部署：Dockerfile 多阶段（Node 构建前端，Python 运行后端+静态资源），环境变量注入。

### Mongo 数据模型（集合）

- mp_accounts：`_id`, `name`, `token`, `cookie`, `remark`, `updated_at`.
- targets：`_id`, `name`, `biz?`, `freq_minutes`, `enabled`, `account_id`, `last_run_at`, `created_at`.
- articles：`_id`, `mp_name`, `mp_id`, `title`, `url`(唯一索引), `publish_at`, `cover?`, `digest?`, `target_id`, `created_at`.
- users（后台登录）：`_id`, `username`, `password_hash`, `roles`, `created_at`.

### 后端接口（草案）

- 鉴权：`POST /api/auth/login` -> JWT；全局依赖校验。
- 账号配置：`GET/POST/PUT/DELETE /api/mp-accounts`.
- 公众号配置：`GET/POST/PUT/DELETE /api/targets`，支持启用/停用、更新频率。
- 文章查询：`GET /api/articles`（分页、按公众号/时间筛选）。
- 调度控制：`POST /api/targets/{id}/run` 手动触发；APScheduler 按 `freq_minutes` 周期执行。

### 爬虫封装

- 从 `utils` 抽出纯函数，去除 UI 依赖：
  - `fetch_article_list(token, cookie, mp_name, since=None, until=None) -> list[ArticleMeta]`
  - `fetch_article_content(url, token, cookie)`（若需内容）
- 调度任务流程：读取 `mp_accounts` -> 取 token/cookie -> 逐目标爬取 -> 去重写入 `articles` -> 记录运行日志/错误。

### 前端页面

- 登录页：表单获取 JWT，保存 localStorage；路由守卫。
- 账号管理：表格 + 新增/编辑对话框（名称、token、cookie、备注）。
- 公众号配置：表格 + 新增/编辑（名称、频率、绑定账号、启用），支持手动触发。
- 文章列表：表格（公众号、发布时间、标题、链接），筛选/分页。

### 部署与环境

- 环境变量：`MONGO_URI`, `MONGO_DB`, `MONGO_INITDB_ROOT_USERNAME`, `MONGO_INITDB_ROOT_PASSWORD`, `MONGO_USER`, `MONGO_PASS`, `MONGO_AUTH_SOURCE`, `JWT_SECRET`, `JWT_EXPIRE_MIN`, `REQUEST_MIN_DELAY`, `REQUEST_MAX_DELAY`, `REQUEST_TIMEOUT`, `REQUEST_RETRIES`, `LOG_LEVEL`。
- Dockerfile 多阶段：
  1. `node:20-alpine` 构建前端产物到 `frontend/dist`
  2. `python:3.11-slim` 安装精简后端依赖 `requirements-backend.txt`；复制 backend/crawler 和 `dist` 作为静态文件；入口 `gunicorn -b 0.0.0.0:8000 backend.app:app`
- docker-compose：见仓库 `docker-compose.yml`，包含 `app` + `mongo`（持久卷）。
- 环境示例：`env.sample`。

### 后续实施步骤

1. 抽取爬虫核心到 `crawler/`，提供纯函数 API。
2. 初始化 Flask 项目，定义 Blueprint、JWT、中间件（CORS、日志）。
3. 接入 Mongo（pymongo），实现接口与唯一索引（articles.url）。
4. 集成 APScheduler 注册任务（随启动加载 targets）。
5. 初始化前端（Vite+Vue3+Element Plus），实现登录、账号管理、目标管理、文章列表。
6. 编写 Dockerfile 与基础 compose，验证一键启动。（已完成初版）

### 运行说明（补充）

- 本地/容器运行变量示例见 `env.sample`。
- docker-compose 启动：`docker-compose up --build -d`（默认暴露 8000，Mongo 27017）。
- 开发模式：后端 `python -m flask --app backend.app run`（或 `gunicorn`），前端在 `frontend/` 执行 `npm install && npm run dev`，通过 `/api` 代理到后端。
